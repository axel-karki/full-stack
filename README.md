## Infrastructure Setup on Hetzner Root Server

This repository documents the setup and configuration of a virtualized infrastructure using **Proxmox VE** on a Hetzner root server, including the network configuration and service deployment using Ansible.

---

## Initial Server Provisioning

### Provider

* **Hetzner** (dedicated root server)

### OS Installation

When Hetzner provisions a new server, it is initially placed in **rescue mode**. To install a fresh Debian OS:

```bash
installimage
```

* Selected **Debian Bookworm**
* Configured disk partitioning and hostname
* Rebooted into the new OS after installation

---

## Virtualization Layer: Proxmox VE

### Installation

After installing Debian Bookworm, **Proxmox VE** was installed on top to enable virtual machine (VM) management and orchestration.

### Web Interface

Proxmox provides a browser-based UI (`https://<your-server-ip>:8006`) to manage VMs, containers, storage, and networking.

---

## VM Network Access

### Initial Setup with Linux Bridge (Bridged Mode)

* Created a Linux bridge interface (`vmbr0`) to share the host's network with VMs
* Assigned VMs public IPs from the same subnet

**Issue:**
This approach resulted in MAC address leakage because bridged VMs used their own MAC addresses. Hetzner detected unauthorized MAC addresses on the network and sent a warning email.

```
root@proxmox-server1 ~ # cat /etc/network/interfaces
# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

iface lo inet6 loopback

iface enp6s0 inet manual

auto vmbr0
iface vmbr0 inet static
	address 37.27.133.94/26
	gateway 37.27.133.65
	bridge-ports enp6s0
	bridge-stp off
	bridge-fd 0

iface vmbr0 inet6 static
	address 2a01:4f9:3071:154d::2/64
	gateway fe80::1
```

### Resolution with NAT (Masquerading)

To resolve the MAC leakage issue:

* Switched to **NAT (masquerading)** for VM internet access
* Configured a private subnet (e.g., `10.0.0.0/24`) for VMs
* Enabled IP forwarding and used `iptables` rules to NAT traffic through the host

This approach:

* Prevents MAC address leakage
* Allows full internet access to VMs
* Complies with Hetznerâ€™s network policies

```
source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

iface lo inet6 loopback

auto enp6s0
iface enp6s0 inet static
    address 37.27.133.94
    netmask 255.255.255.192
    gateway 37.27.133.65

iface enp6s0 inet6 static
    address 2a01:4f9:3071:154d::2/64
    gateway fe80::1

# NAT LAN for VMs (no physical port, isolated)
auto vmbr1 # automatically bring up the vmbr1 bridge interface during boot. 
iface vmbr1 inet static
    address 10.0.0.1
    netmask 255.255.255.0
    bridge_ports none # No physical NIC is attached to this bridge. virtual-only bridge, used to connect internal VMs without exposing them directly to the external network.
    bridge_stp off # Since no physical ports are involved, STP (Spanning Tree Protocol) isn't needed here.
    bridge_fd 0 # Forwarding delay 0
    
    # Enables IP forwarding after the interface comes up.
    # This allows traffic to be routed between interfaces (e.g., from VM subnet to internet).
    post-up echo 1 > /proc/sys/net/ipv4/ip_forward
    
    
    post-up iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o enp6s0 -j MASQUERADE
    
    # Removes the same NAT rule when vmbr1 is brought down.
		# Prevents stale iptables rules if interface restarts.
    post-down iptables -t nat -D POSTROUTING -s 10.0.0.0/24 -o enp6s0 -j MASQUERADE
```

---
## Core Application & CI/CD Infrastructure (Ansible)

 * [Docker Swarm](https://github.com/axel-karki/docker-swarm-ansible)

 * [Gitlab Self Host](https://github.com/axel-karki/gitlab-self-host)
 * [Gitlab Runner](https://github.com/axel-karki/gitlab-runner)


## Database & Messaging Services Deployment (Ansible)

 * [Data Warehouse: ClickHouse](https://github.com/axel-karki/clickhouse-ansible)
 * [MinIO Backup](https://github.com/axel-karki/minio-ansible)
 * [Graph Database: Neo4j with DozerDB](https://github.com/axel-karki/neo4j-dozer-ansible)
 * [NoSQL Database: MongoDB](https://github.com/axel-karki/ansible-mongo)
 * [Streaming System: Apache Kafka](https://github.com/axel-karki/kafka-ansible)
 * [Messaging System: NATS](https://github.com/axel-karki/nats-server-ansible)
 * [Beszel Installation & Setup](https://github.com/axel-karki/beszel-ansible)
